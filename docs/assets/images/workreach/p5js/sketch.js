function computeTransitionWeight(e,t,i){return null==t?1:1/(1+Math.exp(-i*(e-t)))}function predictFlowsWithUtilityModel(e,t){const i=e.length;let l=Array(i).fill(null).map((()=>Array(i).fill(0))),o=Array(i).fill(null).map((()=>Array(i).fill(0)));for(let t=0;t<i;t++)for(let l=0;l<i;l++)t!==l?(o[t][l]=dist(e[t].x,e[t].y,e[l].x,e[l].y),o[t][l]<1&&(o[t][l]=1)):o[t][l]=0;for(let a=0;a<i;a++)for(let n=0;n<i;n++){const i=o[a][n],r=e[n].eci,s=e[a].informality/100;let c;if(t.transition&&null!==t.threshold){const e=computeTransitionWeight(i,t.threshold,t.k_transition);c=t.beta_distance*i+e*(t.beta_eci*r)+e*(t.beta_informality*s)}else c=t.beta_distance*i+t.beta_eci*r+t.beta_informality*s;l[a][n]=c}let a=Array(i).fill(null).map((()=>Array(i).fill(0)));for(let e=0;e<i;e++){let t=-1/0;for(let o=0;o<i;o++)l[e][o]>t&&(t=l[e][o]);let o=0,n=Array(i).fill(0);for(let a=0;a<i;a++)n[a]=Math.exp(l[e][a]-t),o+=n[a];if(0===o)for(let t=0;t<i;t++)a[e][t]=0;else for(let t=0;t<i;t++)a[e][t]=n[t]/o}for(let e=0;e<i;e++)a[e][e]=0;for(let e=0;e<i;e++){let t=0;for(let l=0;l<i;l++)t+=a[e][l];if(t>1e-10)for(let l=0;l<i;l++)a[e][l]/=t;else for(let t=0;t<i;t++)a[e][t]=0}let n=[];for(let t=0;t<i;t++)for(let l=0;l<i;l++){if(t===l)continue;let i=a[t][l]*e[t].pop;n.push({from:e[t],to:e[l],value:i})}return n}function setup(){canvasWidth=min(.95*windowWidth,1200),canvasHeight=.6*canvasWidth,canvasHeight>.85*windowHeight&&(canvasHeight=.85*windowHeight,canvasWidth=canvasHeight/.6),createCanvas(canvasWidth,canvasHeight),bgColor=color(10,20,40),stateColor=color(200,220,255,180),particleColorStart=color(255,100,100,180),particleColorEnd=color(255,200,100,180),flowLineColor=color(100,150,255,50),textColor=color(230,240,255),highlightColor=color(255,255,0),initializeLocations();let e=20,t=130,i=150,l=22,o=20;betaDistSlider=createSlider(-.1,0,-.005,.001),betaDistSlider.position(e+i,o),betaDistSlider.style("width",t+"px"),o+=l,betaEciSlider=createSlider(0,2,.85,.01),betaEciSlider.position(e+i,o),betaEciSlider.style("width",t+"px"),o+=l,betaInfoSlider=createSlider(-10,10,-6.5,.01),betaInfoSlider.position(e+i,o),betaInfoSlider.style("width",t+"px"),o+=l;let a=sqrt(width*width+height*height);thresholdSlider=createSlider(0,a/2,a/4,1),thresholdSlider.position(e+i,o),thresholdSlider.style("width",t+"px"),o+=l,kTransitionSlider=createSlider(.001,.1,.06,.001),kTransitionSlider.position(e+i,o),kTransitionSlider.style("width",t+"px"),o+=l,transitionCheckbox=createCheckbox("Use Transition Logic",!0),transitionCheckbox.position(e,o),transitionCheckbox.style("color",textColor.toString()),o+=l,showNamesCheckbox=createCheckbox("Show State Names",!1),showNamesCheckbox.position(e,o),showNamesCheckbox.style("color",textColor.toString()),o+=l+10,selectedStateLabel=createP(""),selectedStateLabel.position(e,o),selectedStateLabel.style("color",textColor.toString()),selectedStateLabel.style("font-weight","bold"),o+=l+5,selectedStateEciLabel=createP("State ECI:"),selectedStateEciLabel.position(e,o),selectedStateEciLabel.style("color",textColor.toString()),selectedStateEciSlider=createSlider(-2,2,0,.01),selectedStateEciSlider.position(e+i-30,o),selectedStateEciSlider.style("width",t+"px"),o+=l,selectedStateInfoLabel=createP("State Informality (%):"),selectedStateInfoLabel.position(e,o),selectedStateInfoLabel.style("color",textColor.toString()),selectedStateInfoSlider=createSlider(0,100,50,1),selectedStateInfoSlider.position(e+i-30,o),selectedStateInfoSlider.style("width",t+"px"),hideSelectedStateControls()}function initializeLocations(){locations=[];for(let e of statesData){let t=map(e.lon,minLon,maxLon,padding,width-padding),i=map(e.lat,maxLat,minLat,padding,height-padding),l=map(e.pop,.5,17,6,22);locations.push({...e,x:t,y:i,baseSize:l,displayName:"M\xe9xico State"===e.name?"Edo. Mex.":"Mexico City"===e.name?"CDMX":e.name})}}function draw(){if(background(bgColor),selectedState&&"none"!==selectedStateEciSlider.elt.style.display){let e=selectedStateEciSlider.value(),t=selectedStateInfoSlider.value(),i=!1,l=locations.find((e=>e.name===selectedState.name));l&&(l.eci!==e&&(l.eci=e,i=!0),l.informality!==t&&(l.informality=t,i=!0)),selectedStateEciLabel.html("State ECI: "+e.toFixed(2)),selectedStateInfoLabel.html("State Informality (%): "+t.toFixed(0))}let e={beta_distance:betaDistSlider.value(),beta_eci:betaEciSlider.value(),beta_informality:betaInfoSlider.value(),threshold:thresholdSlider.value(),k_transition:kTransitionSlider.value(),transition:transitionCheckbox.checked()};displayGlobalSliderValues(e),textSize(16),textAlign(CENTER,CENTER),fill(textColor),text("WorkReach Mobility Model\n(Mexico)",width/2,padding/3);let t=predictFlowsWithUtilityModel(locations,e),i=0;for(let e of t)e.value>i&&(i=e.value);0===i&&(i=1e-6);for(let e of t){let t=constrain(map(e.value,0,i,0,1),0,1);if(t>.001){let i=map(t,0,1,5,70),l=map(t,0,1,.5,4);stroke(red(flowLineColor),green(flowLineColor),blue(flowLineColor),i),strokeWeight(l),line(e.from.x,e.from.y,e.to.x,e.to.y);let o=.1*t;if(random(1)<o&&particles.length<800){let i=map(t,0,1,1,4),l=dist(e.from.x,e.from.y,e.to.x,e.to.y)/i*1.2;i>0&&l>0&&particles.push(new Particle(e.from.x,e.from.y,e.to.x,e.to.y,i,l))}}}for(let e=particles.length-1;e>=0;e--)particles[e].update(),particles[e].display(),particles[e].isDead()&&particles.splice(e,1);let l=15,o=null;for(let e of locations)selectedState&&selectedState.name===e.name?(stroke(255,0,0),strokeWeight(3),fill(red(stateColor)+30,green(stateColor)+30,blue(stateColor)+30,230)):(noStroke(),fill(stateColor)),ellipse(e.x,e.y,e.baseSize,e.baseSize),showNamesCheckbox.checked()&&(fill(textColor),noStroke(),textSize(9),textAlign(CENTER,CENTER),text(e.displayName,e.x,e.y-e.baseSize/2-7)),selectedState&&selectedState.name===e.name||dist(mouseX,mouseY,e.x,e.y)<l+e.baseSize/2&&(o=e);if(o){fill(highlightColor,180),noStroke(),ellipse(o.x,o.y,o.baseSize+6,o.baseSize+6),fill(highlightColor),textSize(11),textAlign(CENTER,BOTTOM),textStyle(BOLD);let e=`${o.name}\nPop: ${o.pop}M\nECI: ${o.eci.toFixed(2)}\nInformality: ${o.informality}%`;text(e,o.x,o.y-o.baseSize/2-15),textStyle(NORMAL);for(let e of t)if(e.from===o||e.to===o){let t=constrain(map(e.value,0,i,0,1),0,1);if(t>.001){let i=map(t,0,1,60,200),l=map(t,0,1,1,5);stroke(highlightColor,i),strokeWeight(l),line(e.from.x,e.from.y,e.to.x,e.to.y)}}}}function displayGlobalSliderValues(e){fill(textColor),noStroke(),textSize(11),textAlign(LEFT,CENTER);let t=20,i=20,l=betaDistSlider.width+10+150,o=22,a=i;text("\u03b2_dist:",t,a+betaDistSlider.height/2),text(e.beta_distance.toFixed(3),t+l,a+betaDistSlider.height/2),a+=o,text("\u03b2_ECI:",t,a+betaEciSlider.height/2),text(e.beta_eci.toFixed(2),t+l,a+betaEciSlider.height/2),a+=o,text("\u03b2_Informality:",t,a+betaInfoSlider.height/2),text(e.beta_informality.toFixed(2),t+l,a+betaInfoSlider.height/2),a+=o,text("Threshold (dist):",t,a+thresholdSlider.height/2),text(e.threshold.toFixed(1),t+l,a+thresholdSlider.height/2),a+=o,text("k_transition:",t,a+kTransitionSlider.height/2),text(e.k_transition.toFixed(3),t+l,a+kTransitionSlider.height/2)}function mousePressed(){let e=!1;for(let t of locations)if(dist(mouseX,mouseY,t.x,t.y)<t.baseSize/1.5+5){selectedState&&selectedState.name===t.name?(selectedState=null,hideSelectedStateControls()):(selectedState=t,showSelectedStateControls()),e=!0;break}!e&&selectedState&&mouseX>300&&(selectedState=null,hideSelectedStateControls())}function showSelectedStateControls(){selectedState&&(selectedStateLabel.html(`Editing: ${selectedState.displayName}`),selectedStateEciSlider.value(selectedState.eci),selectedStateInfoSlider.value(selectedState.informality),selectedStateLabel.show(),selectedStateEciLabel.show(),selectedStateEciSlider.show(),selectedStateInfoLabel.show(),selectedStateInfoSlider.show())}function hideSelectedStateControls(){selectedStateLabel.html(""),selectedStateLabel.hide(),selectedStateEciLabel.hide(),selectedStateEciSlider.hide(),selectedStateInfoLabel.hide(),selectedStateInfoSlider.hide()}function windowResized(){canvasWidth=min(.95*windowWidth,1200),canvasHeight=.6*canvasWidth,canvasHeight>.85*windowHeight&&(canvasHeight=.85*windowHeight,canvasWidth=canvasHeight/.6),resizeCanvas(canvasWidth,canvasHeight),initializeLocations();let e=20,t=130,i=150,l=22,o=20;betaDistSlider.position(e+i,o),o+=l,betaEciSlider.position(e+i,o),o+=l,betaInfoSlider.position(e+i,o),o+=l;let a=sqrt(width*width+height*height);thresholdSlider.remove(),thresholdSlider=createSlider(0,a/2,constrain(thresholdSlider.value(),0,a/2),1),thresholdSlider.position(e+i,o),thresholdSlider.style("width",t+"px"),o+=l,kTransitionSlider.position(e+i,o),o+=l,transitionCheckbox.position(e,o),o+=l,showNamesCheckbox.position(e,o),o+=l+10,selectedStateLabel.position(e,o),o+=l+5,selectedStateEciLabel.position(e,o),selectedStateEciSlider.position(e+i-30,o),o+=l,selectedStateInfoLabel.position(e,o),selectedStateInfoSlider.position(e+i-30,o)}const statesData=[{name:"Aguascalientes",pop:1.4,lat:22,lon:-102.3,eci:.8,informality:40},{name:"Baja California",pop:3.7,lat:30.5,lon:-115.5,eci:.5,informality:35},{name:"Baja California Sur",pop:.8,lat:26,lon:-112,eci:-.2,informality:50},{name:"Campeche",pop:1,lat:19,lon:-90.5,eci:-.9,informality:65},{name:"Chiapas",pop:5.5,lat:16.5,lon:-92.5,eci:-1.2,informality:70},{name:"Chihuahua",pop:3.8,lat:28.5,lon:-106,eci:.6,informality:40},{name:"Coahuila",pop:3.1,lat:27,lon:-102,eci:.9,informality:38},{name:"Colima",pop:.8,lat:19.15,lon:-103.9,eci:-.1,informality:55},{name:"Mexico City",pop:9.2,lat:19.43,lon:-99.13,eci:1.5,informality:30},{name:"Durango",pop:1.8,lat:24.5,lon:-104.5,eci:.1,informality:52},{name:"Guanajuato",pop:6.2,lat:21,lon:-101,eci:.7,informality:45},{name:"Guerrero",pop:3.5,lat:17.7,lon:-99.5,eci:-1,informality:68},{name:"Hidalgo",pop:3.1,lat:20.5,lon:-99,eci:0,informality:58},{name:"Jalisco",pop:8.3,lat:20.5,lon:-103.75,eci:1,informality:42},{name:"M\xe9xico State",pop:17,lat:19.35,lon:-99.55,eci:1.2,informality:40},{name:"Michoac\xe1n",pop:4.7,lat:19.25,lon:-101.75,eci:-.3,informality:60},{name:"Morelos",pop:2,lat:18.75,lon:-99,eci:.2,informality:50},{name:"Nayarit",pop:1.2,lat:22,lon:-105,eci:-.5,informality:62},{name:"Nuevo Le\xf3n",pop:5.8,lat:25.5,lon:-100,eci:1.3,informality:32},{name:"Oaxaca",pop:4.1,lat:17,lon:-96.5,eci:-1.1,informality:72},{name:"Puebla",pop:6.6,lat:19,lon:-98,eci:.4,informality:55},{name:"Quer\xe9taro",pop:2.4,lat:20.75,lon:-100,eci:1.1,informality:37},{name:"Quintana Roo",pop:1.9,lat:19.75,lon:-88,eci:-.4,informality:48},{name:"San Luis Potos\xed",pop:2.8,lat:22.5,lon:-100.5,eci:.3,informality:50},{name:"Sinaloa",pop:3,lat:25,lon:-107.5,eci:0,informality:53},{name:"Sonora",pop:3,lat:29.5,lon:-110,eci:.4,informality:43},{name:"Tabasco",pop:2.4,lat:18,lon:-93,eci:-.8,informality:67},{name:"Tamaulipas",pop:3.5,lat:24,lon:-98.5,eci:.2,informality:47},{name:"Tlaxcala",pop:1.4,lat:19.35,lon:-98.1,eci:-.2,informality:59},{name:"Veracruz",pop:8.1,lat:19.5,lon:-96.75,eci:-.6,informality:63},{name:"Yucat\xe1n",pop:2.3,lat:20.75,lon:-89,eci:-.7,informality:57},{name:"Zacatecas",pop:1.6,lat:23.5,lon:-103,eci:-.1,informality:56}];let locations=[],particles=[];const minLat=14.5,maxLat=32.8,minLon=-118.5,maxLon=-86.5;let betaDistSlider,betaEciSlider,betaInfoSlider,thresholdSlider,kTransitionSlider,transitionCheckbox,showNamesCheckbox,selectedStateEciSlider,selectedStateInfoSlider,selectedStateLabel,selectedStateEciLabel,selectedStateInfoLabel,canvasWidth,canvasHeight,selectedState=null;const padding=70;let bgColor,stateColor,particleColorStart,particleColorEnd,flowLineColor,textColor,highlightColor;class Particle{constructor(e,t,i,l,o,a){this.pos=createVector(e,t),this.vel=createVector(i-e,l-t),this.vel.normalize(),this.vel.mult(random(.5,1.5)*o),this.endPos=createVector(i,l),this.lifespan=a,this.originalLifespan=a,this.alpha=255,this.size=random(2,4),this.color=lerpColor(particleColorStart,particleColorEnd,random(1))}update(){this.pos.add(this.vel),this.lifespan--,this.alpha=map(this.lifespan,0,this.originalLifespan,0,200),p5.Vector.dist(this.pos,this.endPos)<2*this.vel.mag()&&(this.lifespan=0)}isDead(){return this.lifespan<=0}display(){noStroke(),fill(red(this.color),green(this.color),blue(this.color),this.alpha),ellipse(this.pos.x,this.pos.y,this.size,this.size)}}